# GeoKintai 仕様書

## 1. 目的
GeoKintai は、iOS の位置情報機能を使って「仕事場への到着/退出」を自動記録し、監査可能な勤怠証跡を残すアプリである。  
本仕様は実装の正本であり、機能要件・非機能要件・ドメイン制約を定義する。

## 2. 対象範囲
- iOS バックグラウンド位置検知による出退勤自動記録
- 仕事場（複数）の登録/編集/削除
- 手動修正の監査ログ（append-only）
- CSV/PDF エクスポート
- 記録改ざん検知のための整合性ハッシュ

## 3. 用語
- 仕事場: 監視対象の地理的拠点（中心座標 + 半径）
- 滞在判定時間: 入域後、出勤確定に必要な連続滞在時間（5分固定）
- 退勤再確認時間: 出域後、退勤確定に必要な連続半径外時間（2分固定）
- 位置証拠ログ: 判定根拠として保存する GPS サンプル
- 監査ログ: 手動修正の前後差分を追記保存する履歴

## 4. 機能要件（FR）

### FR-01 仕事場管理
- 仕事場を追加/編集/削除できる。
- 各仕事場は `name`, `latitude`, `longitude`, `radius`, `monitoringEnabled` を持つ。
- `latitude` は `-90...90`、`longitude` は `-180...180` の範囲で扱う。
- 緯度・経度入力の前後空白は除去して数値解釈する。

### FR-02 出勤確定（滞在判定）
- `didEnterRegion` を契機に滞在判定を開始する。
- 半径内滞在が 5 分連続した場合のみ出勤確定する。

### FR-03 通過時誤検知防止
- 入域後 5 分未満で半径外へ離脱した場合は出勤確定しない。

### FR-04 退勤確定（再確認）
- `didExitRegion` 直後に退勤確定せず、2分再確認する。
- 2分連続で半径外なら退勤確定する。

### FR-05 勤務中レコード一意性
- 同一仕事場で `exitTime == nil` の勤務中レコードは最大1件とする。

### FR-06 手動修正の監査性
- 手動修正は元レコードを直接上書きしない。
- `AttendanceCorrection` に修正前後・理由・時刻・整合性ハッシュを追記する。

### FR-07 複数仕事場の独立性
- 仕事場単位で記録を分離し、相互汚染を防ぐ。

### FR-08 エクスポート完全性
- CSV/PDF 出力に、出退勤記録、修正履歴、位置証拠、生成時刻、整合性ハッシュを含める。

### FR-09 権限不足時の安全動作
- 位置権限が `When In Use` または `Denied` の場合は自動記録を停止する。
- ユーザーへ必要権限への導線を表示する。

### FR-10 改ざん検知
- 保存データまたは出力データに対し、整合性ハッシュの検証結果を判定できる。

## 5. 非機能要件（NFR）
- NFR-01 時刻整合性: 永続化は UTC 基準 `Date` を用い、表示時のみローカル変換する。
- NFR-02 再現可能性: 判定ロジックはユニットテストで再現可能とする。
- NFR-03 監査可能性: 出退勤判定根拠を `LocationProof` で追跡可能にする。
- NFR-04 追記型監査ログ: 監査ログは append-only で保存する。
- NFR-05 可観測性: 主要イベント（入域/滞在確定/退域/退勤確定/失敗）をログ出力可能にする。
- NFR-06 可用性: 権限不足や位置取得失敗時も既存データを破損させない。

## 6. ドメイン制約
- 滞在判定時間は `5分` 固定。
- 退勤再確認時間は `2分` 固定。
- 仕事場半径の既定値は `100m`。
- 手動修正の理由入力は必須。

## 7. データモデル概要

### 7.1 Workplace
- 拠点情報と監視有効フラグを保持。

### 7.2 AttendanceRecord
- 出勤/退勤の主記録。
- `exitTime == nil` は勤務中を示す。

### 7.3 AttendanceCorrection
- 手動修正の監査ログ。
- 更新/削除禁止、追記のみ。

### 7.4 LocationProof
- 判定中に取得した位置サンプル。
- `reason`（EntryTrigger/StayCheck/ExitCheck）を必須とする。

## 8. 実装制約
- 言語: Swift
- UI: SwiftUI（Dynamic Type 対応の標準コンポーネント優先）
- 位置 API: `CLLocationManager` + `CLRegionMonitoring`
- 永続化: Core Data（または SwiftData）

## 9. 非対象（Out of Scope）
- 勤務区分（休憩、深夜手当など）の給与計算ロジック
- サーバー同期/クラウドバックアップ
- Apple Watch 連携

## 10. 関連文書
- [acceptance_criteria.md](acceptance_criteria.md)
- [logic_flow.md](logic_flow.md)
- [tdd_rules.md](tdd_rules.md)
- [requirements_traceability.md](requirements_traceability.md)
