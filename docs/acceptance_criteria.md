# 受け入れ基準 (Implementation Gate)

この文書は、実装前に合意しておく機能の合格条件を定義します。  
記法は `Given / When / Then` を基本とします。

## 0. 前提
- 位置情報権限は `Always` を主系とする。
- 仕事場の初期半径は `100m`。
- 出勤確定の滞在判定時間は `5分`（確定）。
- 退勤確定の再確認時間は `2分`（確定）。

## 0.1 用語
- 再確認時間: `didExitRegion` の直後に即退勤させず、一定時間連続で半径外にいることを確認する検証ウィンドウ（GPSドリフト対策）。

## 1. 機能受け入れ基準

### AC-01 仕事場の登録・編集・削除
- Given: ユーザーが設定画面にいる
- When: 現在地登録または地図ピンドロップで仕事場を保存する
- Then: `name`, `latitude`, `longitude`, `radius`, `monitoringEnabled` が永続化される
- Then: 削除時は監視対象リージョンからも除外される

### AC-02 出勤確定（滞在判定あり）
- Given: 監視対象仕事場が有効で、ユーザーは未勤務状態
- When: `didEnterRegion` 後に滞在判定時間の間、中心から半径内に留まる
- Then: 出勤レコードが1件作成され、`entryTime` が記録される
- Then: 判定に用いた位置サンプルが `LocationProof` として保存される

### AC-03 通過時の誤検知防止
- Given: 監視対象仕事場が有効
- When: `didEnterRegion` は発火するが滞在判定時間内に半径外へ離脱する
- Then: 出勤レコードは作成されない

### AC-04 退勤確定（GPSドリフト耐性）
- Given: 勤務中レコード（`exitTime == nil`）が1件ある
- When: `didExitRegion` 後に再確認時間中も半径外にいる
- Then: 既存レコードの `exitTime` が更新される
- Then: 再確認中の位置サンプルが `LocationProof` に保存される
- Then: 再確認中に半径内へ戻った場合は退勤を確定しない

### AC-05 勤務中レコードの一意性
- Given: ある仕事場に `exitTime == nil` のレコードが存在する
- When: 同一仕事場で出勤確定処理が再実行される
- Then: 新規レコードは作られず、重複勤務中状態を作らない

### AC-06 手動修正と監査性
- Given: 自動記録済みレコードが存在する
- When: ユーザーが時刻を手動修正する
- Then: 元データは上書きせず、`AttendanceCorrection` に追記される
- Then: 修正理由、修正前後の値、修正日時、整合性ハッシュが残る

### AC-07 複数仕事場の独立記録
- Given: 複数の仕事場が登録済み
- When: それぞれのリージョンで出退勤イベントが発生する
- Then: 記録は `workplaceId` ごとに分離して保存され、相互汚染しない

### AC-08 エクスポートの完全性
- Given: 出退勤記録と証拠ログが存在する
- When: CSVまたはPDFを出力する
- Then: 最低限、以下を含む
  - レコードID、仕事場ID/名称、出退勤時刻（UTCと表示時刻）
  - 手動修正有無、修正履歴（前後値・理由・時刻）
  - 位置証拠（timestamp, lat/lon, accuracy, reason）
  - エクスポート生成時刻、整合性ハッシュ
- Then: 出力失敗時はユーザーへ失敗理由を提示する

### AC-09 権限不足時の安全動作
- Given: 位置情報権限が `When In Use` または `Denied`
- When: バックグラウンド検知が必要な操作を行う
- Then: 自動記録を行わず、必要権限への導線を表示する
- Then: 既存データは破損しない

### AC-10 改ざん検知可能性
- Given: 記録済みデータまたはエクスポート済みデータがある
- When: データ整合性チェックを実行する
- Then: ハッシュ不一致を検知できる
- Then: 不一致時は当該レコードを「検証失敗」として識別できる

## 2. 非機能受け入れ基準

### NFC-01 一貫した時刻記録
- 全レコードは `Date` で保存し、表示時のみローカルタイムゾーンに変換する。

### NFC-02 再現可能性
- 主要ロジック（滞在判定、退勤判定、重複防止）はユニットテストで再現可能である。

### NFC-03 監査可能性
- 出退勤確定の根拠となる位置サンプルが、対象レコードへ追跡可能に紐づく。

### NFC-04 追記型監査ログ
- 修正履歴と証拠ログは追記型で保存し、削除・上書きに依存しない監査追跡が可能である。
