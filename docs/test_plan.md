# Test Plan & Simulator Guide

## 概要
GeoKintaiのバックグラウンド位置連動機能（ジオフェンス進入→滞在監視→出勤確定）を、実機を持たずにXcodeシミュレータのみで検証する手順書。

## 1. テスト準備 (GPXファイル)
Xcodeのシミュレータは、GPX（GPS Exchange Format）ファイルを読み込むことで、任意の場所や経路を移動させることができる。

### GPXファイル一覧 (`SimulatedLocations/`)

| ファイル名 | 用途 | 期待される動作 |
|-----------|------|---------------|
| Workplace.gpx | 仕事場の中心座標 | 仕事場登録時のピン位置確認用 |
| Commute_In.gpx | 出勤シミュレーション | 出勤が検知され、ステータスが「勤務中」になる |
| Commute_Out.gpx | 退勤シミュレーション | 退勤が検知され、退勤時刻が記録される |
| Pass_By.gpx | 通過のみ | 出勤にならない（誤検知防止確認） |
| Short_Stay.gpx | 短時間滞在（5分未満） | 出勤にならない（検証期間未完了） |
| GPS_Drift.gpx | GPS精度揺らぎ | 勤務中のまま維持（誤った退勤にならない） |
| Multiple_Visits.gpx | 1日複数回出入り | 2つの出勤レコードが作成される |
| Boundary_Edge.gpx | 境界線上での滞在 | 正常に出勤検知される |
| Fast_Transit.gpx | 高速移動（電車等） | 出勤にならない（通過扱い） |
| Late_Night.gpx | 深夜の出勤 | 時間帯に関係なく正常に記録される |

## 2. Xcodeでの実行手順

### 手順A: デバッグ実行中の操作
1. アプリをSimulatorで起動（**Debugモード**）。
2. Xcodeのメニューバー `Debug` > `Simulate Location` を選択。
3. `Add GPX File to Workspace...` から作成したGPXを選択。
4. シミュレーションが開始され、青い矢印（現在地）が動き出す。

### 手順B: バックグラウンド動作の確認
1. `Status` タブで監視が有効になっていることを確認。
2. 一度、ホーム画面に戻る（`Shift + Command + H`）。
3. `Simulate Location` で GPXファイルを再生開始。
4. **期待される挙動**:
    - Xcodeのコンソールログに `didEnterRegion`, `startUpdatingLocation`, `Stay Confirmed` 等のログが出力される。
    - 再度アプリを開くとステータスが変化している。

## 3. テストシナリオ一覧

### 基本シナリオ
| ID | シナリオ名 | 使用GPX | 手順 | 期待値 |
|---|---|---|---|---|
| T-001 | 正常な出勤 | Commute_In | バックグラウンドで再生、5分以上待機 | ステータスが「勤務中」、ログに記録 |
| T-002 | 正常な退勤 | Commute_Out | 勤務中状態から再生 | ステータスが「退勤中」、退勤時刻記録 |
| T-003 | 通過のみ（誤検知防止） | Pass_By | バックグラウンドで再生 | ステータス変化なし |
| T-004 | アプリキル後の検知 | Commute_In | タスクキル後に再生 | (シミュレータでは再現不可、実機推奨) |

### エッジケースシナリオ
| ID | シナリオ名 | 使用GPX | 手順 | 期待値 |
|---|---|---|---|---|
| T-005 | 短時間滞在 | Short_Stay | 5分未満で離脱 | 出勤記録なし |
| T-006 | GPS精度揺らぎ | GPS_Drift | 勤務中状態で再生 | 勤務中のまま（誤退勤なし） |
| T-007 | 1日複数回出入り | Multiple_Visits | 全体を再生 | 2つの出勤レコード |
| T-008 | 境界線上滞在 | Boundary_Edge | バックグラウンドで再生 | 正常に出勤検知 |
| T-009 | 高速移動通過 | Fast_Transit | バックグラウンドで再生 | 出勤記録なし |
| T-010 | 深夜の出勤 | Late_Night | バックグラウンドで再生 | 正常に出退勤記録 |

### 複合シナリオ
| ID | シナリオ名 | 手順 | 期待値 |
|---|---|---|---|
| T-011 | 複数仕事場 | 2つの仕事場を登録、それぞれにCommute_Inを実行 | 各仕事場に独立した記録 |
| T-012 | 権限変更 | 「常に許可」→「使用中のみ」に変更 | バックグラウンド検知が停止 |
| T-013 | 機内モード | 機内モードONで再生 | GPS取得できず、検知なし |

## 4. チェックリスト

### テスト実行前
- [ ] 仕事場が登録されている（Settings > Workplaces）
- [ ] 監視が有効になっている（monitoringEnabled = true）
- [ ] 位置情報権限が「常に許可」になっている
- [ ] Xcodeのコンソールログが表示されている

### テスト実行後の確認項目
- [ ] ステータスが期待通りに変化した
- [ ] Historyタブに記録が追加された
- [ ] LocationProofが保存されている（HistoryDetailで確認）
- [ ] コンソールログにエラーがない

## 5. 注意事項
- シミュレータではリージョン監視のバックグラウンド起動が完全には再現できない場合がある。重要なテストは実機で行うこと。
- GPXファイルの時間間隔は検証タイマー（5分）を考慮して設定すること。
- 複数のGPXファイルを連続実行する場合は、間にリセット時間を設けること。
